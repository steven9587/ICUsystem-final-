
@{
    ViewBag.Title = "Switch";


}

@section head
{
}
@section body
{

    <div>
        <div class="left">
            <div class="patient_info" id="patient_window" style="resize:none; border:none;" cols="45" rows="80">
                <!--病人姓名-->
                <div style="float:left;margin-top:6px">
                    <label for="patient_name">病人姓名 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:240px" type="text" class="form-control" id="patient_name">
                </div>
                <!--出生年月日 -->
                <div style="float:left;margin-top:6px">
                    <label for="patient_birthday">出生年月日 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:224px" type="text" class="form-control" id="patient_birthday">
                </div>
                <!--病歷號 -->
                <div style="float:left;margin-top:6px;">
                    <label for="his_no">病歷號 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:255px" type="text" class="form-control" id="his_no">
                </div>
                <!--床號 -->
                <div style="float:left;margin-top:6px;">
                    <label for="bed_no">床號 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:270px" type="text" class="form-control" id="bed_no">
                </div>

                <!--身分證字號-->
                <div style="float:left;margin-top:6px">
                    <label for="patient_id_no">身分證字號 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:224px" type="text" class="form-control" id="patient_id_no">
                </div>


                <!--入ICU日 -->
                <div style="float:left;margin-top:6px;">
                    <label for="in_ICU_date">入ICU日 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:243px" type="text" class="form-control" id="in_ICU_date">
                </div>
                <!--入院日 -->
                <div style="float:left;margin-top:6px;">
                    <label for="in_adm_date">入院日 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:255px" type="text" class="form-control" id="in_adm_date">
                </div>
                <!--身高 -->
                <div style="float:left;margin-top:6px;">
                    <label for="patient_height">身高 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:270px" type="text" class="form-control" id="patient_height">
                </div>
                <!--體重 -->
                <div style="float:left;margin-top:6px;">
                    <label for="patient_weight">體重 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:270px" type="text" class="form-control" id="patient_weight">
                </div>

                <!--科別 -->
                <div style="float:left;margin-top:6px;">
                    <label for="patient_division">科別 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:270px" type="text" class="form-control" id="patient_division">
                </div>
                <!--主治醫師 -->
                <div style="float:left;margin-top:6px;">
                    <label for="dr_no">主治醫師 : </label>
                </div>
                <div style="float:left;margin-left:10px">
                    <input style="padding:0px;width:240px" type="text" class="form-control" id="dr_no">
                </div>
            </div>

            <div class="shift" id="shift_window" style="border:none;">
                <p>Leave your message here：</p>
                <textarea id="patinetNote" style="resize:none;width:320px;height:80px;" name="PatinetNote" cols="130" rows="2" required validationMessage="請輸入內容簡介"></textarea>
                <button type="button" class="btn btn_note" id="note_history" style="background-color: #CCDDFF; color:#194284; float:right; margin-right:10px">備註單</button>
                <button type="button" class="btn btn_search" id="note_insert" style="background-color: #CCDDFF; color:#194284; float:right; margin-right:10px">Send</button>
            </div>
        </div>
        <div class="middle">
            <div class="inspection" id="check" style="border:none;">
                <div class="grid_box" id="check_grid" style="overflow-y:hidden"></div>
            </div>
            <div class="dr_order" id="doctor" style="border:none;">
                <button type="button" id="btn_mhistory" class="btn btn_search" style="background-color: #CCDDFF; color:#194284; float:right; margin-right:10px">Medicine History</button>
            </div>
            <div class="tpr" id="tpr_open" style="position: relative;width:745px;">
                <div id="tpr_chart_week" style="width:710px; height:320px;"></div>
            </div>
        </div>
        <div id="andy_open">
            <img src="https://imgur.com/zbthKQd.jpg" style="width:398px; height:395px;">
        </div>
    </div>
    <div class="uk-card  uk-text-left" id="andy_window" style="display:none">
        <div id="tabstrip_andyfullio">
            <ul>
                <li class="k-state-active">
                    人形化管路標示圖
                </li>
                <li>
                    總I/O表格
                </li>
            </ul>
            <div>
                <span class="andy_tag">&nbsp;</span>
                <div class="row">
                    <div class="Full_column">
                        <canvas id="full" width="600" height="600"></canvas>
                    </div>
                    <div class="helloworld">
                        <div id="tabstrip_tubeio">
                            <ul>
                                <li class="k-state-active">
                                    管路詳細資料
                                </li>
                                <li>
                                    管路I/O
                                </li>
                            </ul>
                            <div>
                                <span class="tube_tag" style="overflow: auto;">&nbsp;</span>
                                <div class="form-group">
                                    <form id="addTubeForm" data-role="validator" novalidate="novalidate">
                                        <div class="form-group" style="margin-bottom:10px">
                                            <label for="pipelineLocation" class="required">管路位置: </label>
                                            <select id="pipeline_Location" name="pipelineLocation" required validationMessage="請選擇管路位置" style="width: 100%;"></select>
                                            <div>
                                                <span class="k-invalid-msg" data-for="pipelineLocation"></span>
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin-bottom:10px">
                                            <label for="pipelineName" class="required">管路名稱: </label>
                                            <select id="pipeline_Name" name="PipelineName" required validationMessage="請選擇管路名稱" style="width: 100%;"></select>
                                            <div>
                                                <span class="k-invalid-msg" data-for="pipelineName"></span>
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin-bottom:10px">
                                            <label for="bought_datepicker" class="required">放置日期:</label>
                                            <input type="text" data-role='datepicker' id="start_datepicker" name="startdatepicker"
                                                   data-type="date" style="width: 100%;" required validationMessage="請輸入正確日期格式" />
                                            <span data-for='startdatepicker' class='k-invalid-msg'></span>
                                        </div>
                                        <div class="form-group" style="margin-bottom:10px">
                                            <label for="bought_datepicker" class="required">到期日期:</label>
                                            <input type="text" data-role='datepicker' id="expiry_datepicker" name="expirydatepicker"
                                                   data-type="date" style="width: 100%;" required validationMessage="請輸入正確日期格式" />
                                            <span data-for='expirydatepicker' class='k-invalid-msg'></span>
                                        </div>
                                        <div class="form-group" style="margin-bottom:10px">
                                            <label for="caliber" class="required"> 管路口徑(french):</label>
                                            <input id="caliber" name="Caliber" style="width: 100%;" type="text" min="1" max="34" value="1" required data-max-msg="Enter french between 1 and 34" />
                                            <span class="k-invalid-msg" data-for="Caliber"></span>
                                        </div>
                                        <div class="form-group" style="margin-bottom:10px">
                                            <label for="inbodycm" class="required">管路埋入公分數:</label>
                                            <input id="inbodycm" name="Inbodycm" style="width: 100%;" type="text" min="1" max="100" value="1" required data-max-msg="Enter cm between 1 and 34" />
                                            <span class="k-invalid-msg" data-for="Inbodycm"></span>
                                        </div>
                                        <div class="form-group" style="">
                                            <label for="caliber" class="required">備註：</label>
                                            <textarea id="pipeline_Note" name="PipeLineNote" onkeyup="WordsDeal();" style="width: 95%;" cols="100" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-10">
                                            <input type="button" id="insert" value="Insert" class="btn" style="background-color: #CCDDFF; color:#194284" />
                                            <input type="button" id="save" value="Save" class="btn btn_save" style="background-color: #CCDDFF; color:#194284" />
                                            <input type="button" id="delete" value="Delete" class="btn" style="background-color: #99b2db; color:#194284" />
                                            <!--<input type="button" id="io_btn" value="IO" class="btn" style="background-color: #CCDDFF; color:#194284" />-->
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div>
                                <span class="tubeio_tag">&nbsp;</span>
                                <div class="row">
                                    <div class="Full_column">
                                        <label for="bought_datepicker" class="required">日期:</label>
                                        <input type="text" data-role='datepicker' id="io_datepicker" name="iodatepicker"
                                               data-type="date" style="width: 50%;" required validationMessage="請輸入正確日期格式" />
                                        <span data-for='iodatepicker' class='k-invalid-msg'></span>

                                        <input type="button" id="btn_secIoSearch" value="search" class="btn" style="background-color: #CCDDFF; color:#194284" />
                                    </div>
                                </div>
                                <br>
                                <b>早班07:01~15:00</b>
                                <div class="tubeiogrid_box" id="tubeiomorning_grid" style=""></div>
                                <b>小夜班15:01~23:00</b>
                                <div class="tubeiogrid_box" id="tubeionight_grid" style=""></div>
                                <b>大夜班23:01~07:00</b>
                                <div class="tubeiogrid_box" id="tubeiograveyard_grid" style=""></div>
                                <b>全日07:01~07:00</b>
                                <div class="tubeiogrid_box" id="tubeioallday_grid" style=""></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tubeiogrid_box" id="alltubeio_grid" style="width:900px;height:300px"></div>
            </div>
            <div>
                <span class="fullio_tag">&nbsp;</span>
                <div class="form-group" style="margin-bottom:10px">
                    <label for="bought_datepicker" class="required">查詢區間:</label>
                    <input type="text" data-role='datepicker' id="iostart_datepicker" name="iostartdatepicker"
                           data-type="date" style="width: 30%;" required validationMessage="請輸入正確日期格式" />
                    <span data-for='iostartdatepicker' class='k-invalid-msg'></span>
                    <b>~</b>
                    <input type="text" data-role='datepicker' id="ioend_datepicker" name="ioenddatepicker"
                           data-type="date" style="width: 30%;" required validationMessage="請輸入正確日期格式" />
                    <span data-for='ioenddatepicker' class='k-invalid-msg'></span>
                    <input type="button" value="search" class="btn btn_io_search" style="background-color: #CCDDFF; color:#194284" />
                </div>
                <div class="fulliorow">
                    <div class="fulliogrid_box" id="fullioin_grid" style="width:450px;height:500px"></div>
                    <div class="fulliogrid_box" id="fullioout_grid" style="width:450px;height:500px"></div>
                </div>
            </div>
        </div>

    </div>
    <div class="uk-card  uk-text-left" id="note_window" style="display:none">
        <div id="note_grid"></div>
    </div>
    <div class="uk-card  uk-text-left" id="tpr_window" style="display:none">
        <div style="margin-top:20px;margin-left:20px;height:5vh;margin-bottom:3px;">
            <h4 style="float:left;">開始時間:</h4>
            <div style="margin-left: 10px;float:left;">
                <input style=" float:left;" id="tpr_start_datepicker" title="datepicker" />
            </div>
            <div style="margin-left: 20px;float:left;">
                <h4 style="float:left;">結束時間:</h4>
            </div>
            <div style="margin-left: 10px;float:left;">
                <input id="tpr_end_datepicker" title="datepicker" />
            </div>
            <div style="margin-left: 20px;float:left;">
                <input type="button" value="search" id="btn_tpr_search" class="btn" style="background-color: #CCDDFF; color:#194284" />
            </div>
        </div>
        <div class="demo-section">
            <div id="tpr_chart" style="width:1150px; height:580px;"></div>
        </div>
    </div>

}
<script type="text/javascript">
    var locatoinX=[0];
    var locatoinY=[0];
    var tubeinsertname = [0];
    var tubecaliber = [0];
    var tubeinbodycm = [0];
    var date=[0];
    var location_point_x;
    var location_point_y;
    var locationLength;
    var x;
    var y;
    var pointlocation;
    var tubepointer;
    var intubation;
    var clickX;
    var clickY;
    var tubepart;
    var tpr_date = "";
    var tpr_sch;
    var breath;
    var pulse;
    var temp;
    var breath_week,pulse_week,temp_week;
    //canvas
    var img = new Image();
    img.src = "https://i.imgur.com/lQx1bV0.jpg";

    var patient_id_search ="";


    $(function () {
        patient_id_search = @Html.Raw(Json.Encode(ViewBag.search_id));
        var Insert = $("#insert").kendoButton({
            icon: "ungroup"
        }).data("kendoButton");
        var Delete = $("#delete").kendoButton({
            icon: "ungroup"
        }).data("kendoButton");
        var Save = $("#save").kendoButton({
            icon: "ungroup",
            //enable: false
        }).data("kendoButton");

        //TPR

        //交班頁面Window
        $("#patient_window").kendoWindow({
            title: "基本資料",
            width:"360px",
            height:"415px",
            Draggable: false,
            resizable:false,
            visible:true,
            pinned:true,
            position: {
                top: 50
            }
        })

        $("#patient_window").parent().find(".k-window-action").css("visibility","hidden");

        $("#note_window").kendoWindow({
            title: "備註清單",
            width:screen.height*1.12,
            height:screen.height*0.77,
            Draggable: false,
            resizable:false,
            visible:false,
            pinned:true,
            modal: true,
            action: ["Minimize",
                     "Maximize",
                     "Close"]
        });
        $("#shift_window").kendoWindow({
            title: "交班、接班",
            width:"360px",
            height:"175px",
            Draggable: false,
            resizable:false,
            visible:true,
            pinned:true,
            position: {
                top: 505
            }
        })
        $("#shift_window").parent().find(".k-window-action").css("visibility","hidden");

        $("#doctor").kendoWindow({
            title: "醫囑",
            width:"417px",
            height:"175px",
            Draggable: false,
            resizable:false,
            visible:true,
            pinned:true,
            position: {
                top: 505,
                left: 1115
            }
        })
        $("#doctor").parent().find(".k-window-action").css("visibility","hidden");

        $("#check").kendoWindow({
            title: "檢驗檢查",
            width:"745px",
            height:"240px",
            Draggable: false,
            resizable:false,
            visible:true,
            pinned:true,
            position: {
                top: 50,
                left: 365
            }
        })
        $("#check").parent().find(".k-window-action").css("visibility","hidden");

        $("#tpr_open").kendoWindow({
            title: "TPR",
            width:"745px",
            height:"350px",
            Draggable: false,
            resizable:false,
            visible:true,
            pinned:true,
            position: {
                top: 330,
                left: 365
            }
        })
        $("#tpr_open").parent().find(".k-window-action").css("visibility","hidden");
        $("#tpr_window").kendoWindow({
            title: "TPR",
            height:screen.height*0.77,
            Draggable: false,
            resizable:false,
            visible:false,
            pinned:true,
            modal: true,
            action: ["Minimize",
                     "Maximize",
                     "Close"],
        });
        $("#io").parent().find(".k-window-action").css("visibility","hidden");

        $("#andy_open").kendoWindow({
            title: "人型化管路顯示圖",
            Draggable: false,
            resizable:false,
            visible:true,
            pinned:true,
            width:"418px",
            height:"415px",
            position: {
                top: 50,
                left: 1115,
            }
        })
        $("#andy_open").parent().find(".k-window-action").css("visibility","hidden");


        $("#andy_window").kendoWindow({
            title: "病人插管資料",
            height:screen.height*0.77,
            Draggable: false,
            resizable:false,
            visible:false,
            pinned:true,
            modal: true,
            action: ["Minimize",
                     "Maximize",
                     "Close"]
        });

        //  $("#andy_window").data("kendoWindow").center();

        $("#check_grid").kendoGrid({
            width:"700px",
            height:"200px",
            columns: [
                { field: "Checkdate", title: "檢查日期", width: "10%" },
                { field: "CheckItem", title: "檢查項目", width: "10%" },
                { field: "ChechNum", title: "檢查數值", width: "20%" }

            ],
            dataSource: {
                data: [{
                    Checkdate: "2019-10-18",
                    CheckItem: "血液",
                    ChechNum: "5.0"
                },
               {
                   Checkdate: "2019-11-22",
                   CheckItem: "尿液",
                   ChechNum: "5.0"
               }]
            }
        });

        //kendoDatePicker
        $("#start_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });

        $("#expiry_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });

        $("#iostart_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });

        $("#ioend_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });

        $("#io_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });

        $("#tpr_start_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });

        $("#tpr_end_datepicker").kendoDatePicker({
            value: new Date(),
            min: "1900-01-01",
            dateInput: true,
            format: "yyyy-MM-dd"
        });
        //kendropdownList
        $("#pipeline_Location").change(function(){
            tubepart = $(this).val();
            $("#pipeline_Name").kendoDropDownList({
                dataTextField: "Text",
                dataValueField: "Value",
                optionLabel: "請選擇",
                cascadeFrom: "tubepart",
                dataSource: {
                    transport: {
                        read: {
                            url: "GetPipeLineDropDownList",
                            data:{
                                "TubePartID":tubepart
                            },
                            type: "post",
                            dataType: "json"
                        }
                    }
                }
            });
        })

        $("#pipeline_Name").kendoDropDownList({
            dataTextField: "Text",
            dataValueField: "Value",
            optionLabel: "請選擇",
            dataSource: {
                transport: {
                    read: {
                        url: "GetPipeLineDropDownListStart",
                        type: "post",
                        dataType: "json"
                    }
                }
            }
        });
        $("#pipeline_Location").kendoDropDownList({
            dataTextField: "Text",
            dataValueField: "Value",
            optionLabel: "請選擇",
            dataSource: {
                transport: {
                    read: {
                        url: "GetTubePartNameDropDownList",
                        type: "post",
                        dataType: "json"
                    }
                }
            }
        });

        //kendoNumericTextBox()
        $("#caliber").kendoNumericTextBox();
        $("#inbodycm").kendoNumericTextBox();

        // get patient detail from db
        patient_id = {
            "PatientId":patient_id_search
        }

        $.ajax({
            type: "POST",
            url: "GetPatientData",
            data: patient_id,
            dataType: "json",
            success: function (data) {
                $("#patient_name").val(data.PatientName);
                $("#patient_id_no").val(data.PatientIdNo);
                $("#patient_birthday").val(data.PatientBirth);
                $("#his_no").val(patient_id_search);
                $("#in_ICU_date").val(data.PatientInICU);
                $("#patient_height").val(data.PatientHeight);
                $("#patient_weight").val(data.PatientWeight);
                $("#dr_no").val(data.DoctorName);
                $("#patient_division").val(data.Division);
                $("#bed_no").val(data.BedId);
                $("#in_adm_date").val(data.PatientAdmdt);

            }
        });



        //小人圖window開啟
        $("#andy_open").click(function (e) {
            Insert.enable(true);
            Delete.enable(false);
            intubation = "";
            $('#andy_window').data("kendoWindow").center().open();
            //read tube x-y from DB
            locatoinX = @Html.Raw(Json.Encode((List<String>)ViewBag.location_x));
            locatoinY =  @Html.Raw(Json.Encode((List<String>)ViewBag.location_y));
            date = @Html.Raw(Json.Encode((List<String>)ViewBag.date));
            tubeinsertname = @Html.Raw(Json.Encode((List<String>)ViewBag.tube_insertname));
            tubecaliber = @Html.Raw(Json.Encode((List<String>)ViewBag.tube_caliber));
            tubeinbodycm = @Html.Raw(Json.Encode((List<String>)ViewBag.tube_inbodycm));
            locationLength = locatoinX.length;
            var lc = document.getElementById("full");
            var rect = lc.getBoundingClientRect();
            var lctx = lc.getContext("2d");
            lctx.drawImage(img, 0, 0, 600, 600);
            //draw the color sample
            //red
            lctx.beginPath();
            lctx.rect(12, 10, 22, 22);
            lctx.fillStyle = "rgb(255,0,0)";
            lctx.fill();
            lctx.lineWidth = 2;
            lctx.strokeStyle = "black";
            lctx.stroke();
            lctx.font = "19px Arial";
            lctx.fillStyle = "rgb(0,0,0)";
            lctx.fillText(": 已過期", 40, 26);
            //yellow
            lctx.beginPath();
            lctx.rect(230, 10, 22, 22);
            lctx.fillStyle = "rgb(242,202,0)";
            lctx.fill();
            lctx.lineWidth = 2;
            lctx.strokeStyle = "black";
            lctx.stroke();
            lctx.font = "18px Arial";
            lctx.fillStyle = "rgb(0,0,0)";
            lctx.fillText(": 將過期(≦24hr)", 258, 26);
            //green
            lctx.beginPath();
            lctx.rect(480, 10, 22, 22);
            lctx.fillStyle = "rgb(2,198,0)";
            lctx.fill();
            lctx.lineWidth = 2;
            lctx.strokeStyle = "black";
            lctx.stroke();
            lctx.font = "18px Arial";
            lctx.fillStyle = "rgb(0,0,0)";
            lctx.fillText(": 未過期", 508, 26);
            //draw tube drom DB
            for (var i = 0; i < locationLength; i++) {
                lctx.beginPath();
                if(date[i]<0){
                    lctx.fillStyle = "rgb(255,0,0)";
                }else if(date[i] == 0){
                    lctx.fillStyle = "rgb(242,202,0)";
                }else{
                    lctx.fillStyle = "rgb(2,198,0)";
                }
                lctx.lineWidth = "2";
                lctx.strokeStyle = 'black';
                //draw tube with size
                if(tubecaliber[i] < 5){
                    lctx.rect((parseInt(locatoinX[i])-5), locatoinY[i], 20, 3);
                }else if(tubecaliber[i] > 5 && tubecaliber[i] < 20){
                    lctx.rect((parseInt(locatoinX[i])-5), locatoinY[i], 20, 7);
                }else{
                    lctx.rect((parseInt(locatoinX[i])-5), locatoinY[i], 20, 10);
                }
                lctx.font = "20px Arial";
                lctx.fillText(tubeinsertname[i]+","+tubeinbodycm[i]+" cm",parseInt(locatoinX[i])+25,parseInt(locatoinY[i])+10);
                lctx.fill();
                lctx.stroke();
            }

            //insert tube
            lc.onclick = function () {

                if (intubation == 'insert') {
                    //draw tube from insert
                    x = event.clientX - 313 - 1;
                    y = event.clientY - 90 - 17;
                    lctx.beginPath();
                    lctx.fillStyle = "rgb(180,209,255)";
                    lctx.lineWidth = "2";
                    lctx.strokeStyle = 'black';
                    lctx.rect(x, y, 10, 10);
                    lctx.fill();
                    lctx.stroke();
                }else{
                    //select tube on canvas
                    clickX = event.clientX - 313 - 1;
                    clickY = event.clientY - 90 - 17;
                    for (var i = 0; i < locationLength; i++) {
                        if (clickX  > parseInt(locatoinX[i]) -10 && clickX < parseInt(locatoinX[i]) + 10 &&
                            clickY > parseInt(locatoinY[i]) -5 && clickY < parseInt(locatoinY[i]) + 5) {
                            tubepointer = i;
                            break;
                        }else{
                            tubepointer = null;
                        }
                    }
                    //change selected tube border color
                    locatoinX = @Html.Raw(Json.Encode((List<String>)ViewBag.location_x));
                    locatoinY = @Html.Raw(Json.Encode((List<String>)ViewBag.location_y));
                    date = @Html.Raw(Json.Encode((List<String>)ViewBag.date));
                    for (var i = 0; i < locationLength; i++) {
                        lctx.beginPath();
                        if(date[i]<0){
                            lctx.fillStyle = "rgb(255,0,0)";
                        }else if(date[i] == 0){
                            lctx.fillStyle = "rgb(242,202,0)";
                        }else{
                            lctx.fillStyle = "rgb(2,198,0)";
                        }
                        lctx.lineWidth = "2";
                        if(i == tubepointer){
                            lctx.strokeStyle = "rgb(180,209,255)";
                        }else{
                            lctx.strokeStyle = 'black';
                        }
                        if(tubecaliber[i] < 5){
                            lctx.rect((parseInt(locatoinX[i])-5), locatoinY[i], 20, 3);
                        }else if(tubecaliber[i] > 5 && tubecaliber[i] < 20){
                            lctx.rect((parseInt(locatoinX[i])-5), locatoinY[i], 20, 7);
                        }else{
                            lctx.rect((parseInt(locatoinX[i])-5), locatoinY[i], 20, 10);
                        }
                        lctx.fill();
                        lctx.stroke();
                        location_point_x =locatoinX[tubepointer];
                        location_point_y =locatoinY[tubepointer];
                    }
                    //傳點選xy到controler
                    if(tubepointer != null){
                        Insert.enable(false);
                        Delete.enable(true);
                        pointlocation = {
                            "LocationX":location_point_x,
                            "LocationY":location_point_y,
                            "PatientId":patient_id_search
                        }
                        $.ajax({
                            type: "POST",
                            url: "GetTubeData",
                            data: pointlocation,
                            dataType: "json",
                            success: function (data) {
                                $("#pipeline_Location").data("kendoDropDownList").value(data.TubePartID);
                                $("#pipeline_Name").data("kendoDropDownList").value(data.TubeNameID);
                                $("#start_datepicker").data("kendoDatePicker").value(data.SysDate);
                                $("#expiry_datepicker").data("kendoDatePicker").value(data.ExpDate);
                                $("#caliber").data("kendoNumericTextBox").value(data.Caliber);
                                $("#inbodycm").data("kendoNumericTextBox").value(data.InBodyCm);
                                $("#pipeline_Note").val(data.TubeNote);
                            }
                        });

                        //here


                    }else{
                        //return to the default
                        Insert.enable(true);
                        Delete.enable(false);
                        $("#pipeline_Location").data("kendoDropDownList").value("");
                        $("#pipeline_Name").data("kendoDropDownList").value("");
                        $("#start_datepicker").data("kendoDatePicker").value(new Date());
                        $("#expiry_datepicker").data("kendoDatePicker").value(new Date());
                        $("#caliber").data("kendoNumericTextBox").value("1");
                        $("#inbodycm").data("kendoNumericTextBox").value("1");
                        $("#pipeline_Note").val("");
                    }
                }
            };



            //第一io
            $("#alltubeio_grid").kendoGrid({
                columns: [
                         { field: "IoDate", title: "日期", width: "10%" },
                         { field: "IoIntake", title: "Intake", width: "10%" },
                         { field: "IoOutput", title: "Output", width: "10%" },
                         { field: "Difference", title: "差異", width: "10%" },

                ],dataSource: {
                    transport: {
                        read: {
                            url: "GetFirstIoGridData",
                            type: "post",
                            dataType: "json",
                            data:patient_id
                        }
                    }
                }
            })

            //第二io按下搜尋鍵取得搜尋條件
            $("#btn_secIoSearch").click(function () {
                //第二io fullio_grid
                iopointlocation = {
                    "LocationX":location_point_x,
                    "LocationY":location_point_y,
                    "PatientId":patient_id_search,
                    //"IoDate":"2020-04-23",
                    "IoDate": kendo.toString($("#io_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                    "IoDateAddOne": kendo.toString(kendo.date.nextDay($("#io_datepicker").data("kendoDatePicker").value()), "yyyy-MM-dd")
                }


                //第二io fullio_grid 特定管路早班夜班小夜班全日資料
                $("#tubeiomorning_grid").kendoGrid({
                    height: "30%",
                    columns: [
                             { field: "IoIntake", title: "Intake", width: "20%" },
                             { field: "IoOutput", title: "Output", width: "20%" },
                             { field: "Difference", title: "差異", width: "20%" },
                    ],dataSource: {
                        transport: {
                            read: {
                                url: "GetSecMorningIoGridData",
                                type: "post",
                                dataType: "json",
                                data:iopointlocation
                            }
                        }
                    }
                })
                $("#tubeionight_grid").kendoGrid({
                    height: "30%",
                    columns: [
                             { field: "IoIntake", title: "Intake", width: "20%" },
                             { field: "IoOutput", title: "Output", width: "20%" },
                             { field: "Difference", title: "差異", width: "20%" },
                    ],dataSource: {
                        transport: {
                            read: {
                                url: "GetSecNightIoGridData",
                                type: "post",
                                dataType: "json",
                                data:iopointlocation
                            }
                        }
                    }
                })
                $("#tubeiograveyard_grid").kendoGrid({
                    height: "30%",
                    columns: [
                             { field: "IoIntake", title: "Intake", width: "20%" },
                             { field: "IoOutput", title: "Output", width: "20%" },
                             { field: "Difference", title: "差異", width: "20%" },
                    ],dataSource: {
                        transport: {
                            read: {
                                url: "GetSecGraveyardIoGridData",
                                type: "post",
                                dataType: "json",
                                data:iopointlocation
                            }
                        }
                    }
                })
                $("#tubeioallday_grid").kendoGrid({
                    height: "30%",
                    columns: [
                             { field: "IoIntake", title: "Intake", width: "20%" },
                             { field: "IoOutput", title: "Output", width: "20%" },
                             { field: "Difference", title: "差異", width: "20%" },
                    ],dataSource: {
                        transport: {
                            read: {
                                url: "GetSecAllDayIoGridData",
                                type: "post",
                                dataType: "json",
                                data:iopointlocation
                            }
                        }
                    }
                })

            });

            //第三io按下搜尋鍵取得搜尋條件
            $(".btn_io_search").click(function () {
                var io_search_data = {
                    "PatientID": patient_id_search,
                    "IoStartDate": kendo.toString($("#iostart_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                    "IoEndDate": kendo.toString($("#ioend_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                };
                //第三io fullio_grid 所有管路io資料(in)
                $("#fullioin_grid").kendoGrid({
                    columns: [
                            { field: "FullIoDate", title: "日期", width: "20%" },
                            { field: "FullIoTime", title: "時間", width: "20%" },
                            { field: "FullIoName", title: "項目名稱", width: "20%" },
                            { field: "FullIoIn", title: "輸入量", width: "20%" },
                            { field: "FullIoUser", title: "輸入者", width: "20%" },
                    ],
                    dataSource: {
                        transport: {
                            read: {
                                url: "GetIoInGridData",
                                type: "post",
                                dataType: "json",
                                data: io_search_data
                            }
                        }
                    }
                })
                //第三io fullio_grid 所有管路io資料(out)
                $("#fullioout_grid").kendoGrid({
                    height: "500px",
                    columns: [
                            { field: "FullIoDate", title: "日期", width: "20%" },
                            { field: "FullIoTime", title: "時間", width: "20%" },
                            { field: "FullIoName", title: "項目名稱", width: "20%" },
                            { field: "FullIoOut", title: "輸出量", width: "20%" },
                            { field: "FullIoUser", title: "輸入者", width: "20%" },
                    ],
                    dataSource: {
                        transport: {
                            read: {
                                url: "GetIoOutGridData",
                                type: "post",
                                dataType: "json",
                                data: io_search_data
                            }
                        }
                    }
                })
            });

        })

        //save data to database
        $("#save").click(function (e) {
            //save insert data
            if(intubation == 'insert') {
                intubation = false;
                var validator = $("#addTubeForm").kendoValidator().data("kendoValidator");
                if (validator.validate()) {
                    var create_data = {
                        "PatientID": patient_id_search,
                        "TubePartID": $("#pipeline_Location").val(),
                        "TubeNameID": $("#pipeline_Name").val(),
                        "SysDate": kendo.toString($("#start_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                        "ExpDate": kendo.toString($("#expiry_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                        "Caliber": $("#caliber").val(),
                        "InBodyCm": $("#inbodycm").val(),
                        "TubeNote": $("#pipeline_Note").val(),
                        "LocationX": x,
                        "LocationY": y.toFixed(0)
                    }
                    $.ajax({
                        type: "POST",
                        url: "InsertData",
                        data: create_data,
                        dataType: "json",
                        success: function (response) {
                            if (response == true) {
                                alert("資料已新增");
                                var PatientId = patient_id_search
                                $.ajax({
                                    type: "post",
                                    url: "Getifo",
                                    data: { "PatientId": PatientId },
                                    success: function (response) {
                                        if (response == true) {
                                            window.location.href = "Switch"
                                        }
                                    }
                                });
                            }
                        },
                        error: function (error) {
                            alert("系統發生錯誤");
                        }
                    });
                }
            }else{
                // sava edit data
                intubation = false;
                var validator = $("#addTubeForm").kendoValidator().data("kendoValidator");
                if (validator.validate()) {
                    var edit_data = {
                        "PatientID": patient_id_search,
                        "TubePartID": $("#pipeline_Location").val(),
                        "TubeNameID": $("#pipeline_Name").val(),
                        "SysDate": kendo.toString($("#start_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                        "ExpDate": kendo.toString($("#expiry_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd"),
                        "Caliber": $("#caliber").val(),
                        "InBodyCm": $("#inbodycm").val(),
                        "TubeNote": $("#pipeline_Note").val(),
                        "LocationX": locatoinX[tubepointer],
                        "LocationY": locatoinY[tubepointer]
                    }
                    $.ajax({
                        type: "POST",
                        url: "EditData",
                        data: edit_data,
                        dataType: "json",
                        success: function (response) {
                            if (response == true) {
                                alert("資料已修改");
                                var PatientId = patient_id_search
                                $.ajax({
                                    type: "post",
                                    url: "Getifo",
                                    data: { "PatientId": PatientId },
                                    success: function (response) {
                                        if (response == true) {
                                            window.location.href = "Switch"
                                        }
                                    }
                                });
                            }
                        },
                        error: function (error) {
                            alert("系統發生錯誤");
                        }
                    });
                }
            }

        });

        //click insert button
        $("#insert").click(function () {
            intubation = 'insert';
            Insert.enable(false);
            Delete.enable(false);
            $("#pipeline_Location").data("kendoDropDownList").value("");
            $("#pipeline_Name").data("kendoDropDownList").value("");
            $("#start_datepicker").data("kendoDatePicker").value(new Date());
            $("#expiry_datepicker").data("kendoDatePicker").value(new Date());
            $("#caliber").data("kendoNumericTextBox").value("1");
            $("#inbodycm").data("kendoNumericTextBox").value("1");
            $("#pipeline_Note").val("");
        });

        //click delete button to delete tube data
        $ ("#delete").click(function (e) {
            pointlocation = {
                "LocationX":location_point_x,
                "LocationY":location_point_y,
                "PatientId":patient_id_search
            }
            $.ajax({
                type: "POST",
                url: "DeleteTube",
                data: pointlocation,
                dataType: "json",
                success: function (response) {
                    if (response == true) {
                        alert("已刪除");
                        var PatientId = patient_id_search
                        $.ajax({
                            type: "post",
                            url: "Getifo",
                            data: { "PatientId": PatientId },
                            success: function (response) {
                                if (response == true) {
                                    window.location.href = "Switch"
                                }
                            }
                        });
                    }
                },
                error: function (error) {
                    alert("系統發生錯誤");
                }
            });

        });




        // 轉藥歷圖
        $("#btn_mhistory").click(function(){
            var PatientId = patient_id_search
            $.ajax({
                type: "post",
                url: "Getifo",
                data: { "PatientId": PatientId },
                success: function (response) {
                    if (response == true) {
                        window.location.href = "MHistory"
                    }
                }
            });
        });



        //管路備註字數限制
        function WordsDeal() {
            var curLength = $("#pipelineNote").val().length;
            if (curLength > 1000) {
                var num = $("#pipelineNote").val().substr(0, 1000);
                $("#pipelineNote").val(num);
                alert("超過字數限制(1000字)，多出的字將被移除！");
            }
        }
        function WordsDealNote() {
            debugger
            var curLength = $("#PatinetNote").val().length;
            if (curLength > 1000) {
                var num = $("#PatinetNote").val().substr(0, 1000);
                $("#PatinetNote").val(num);
                alert("超過字數限制(1000字)，多出的字將被移除！");
            }
        }

        //小人圖總io標籤
        $(document).ready(function () {
            $("#tabstrip_andyfullio").kendoTabStrip({
                animation: {
                    open: {
                        effects: "fadeIn"
                    }
                }
            });
        });

        //管路資料管路io標籤
        $(document).ready(function () {
            $("#tabstrip_tubeio").kendoTabStrip({
                animation: {
                    open: {
                        effects: "fadeIn"
                    }
                }
            });
        });
        //tpr in window
        $("#tpr_open").click(function(e){
            $("#tpr_window").data("kendoWindow").center().open();
            $("#btn_tpr_search").click(function () {
                //read datapicker
                debugger;
                tpr_start_date = kendo.toString($("#tpr_start_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd");
                tpr_end_date = kendo.toString($("#tpr_end_datepicker").data("kendoDatePicker").value(), "yyyy-MM-dd");
                tpr_sch = {
                    "PatientId":patient_id_search,
                    "TPRStart":tpr_start_date,
                    "TPREnd":tpr_end_date
                }
                //日期轉換陣列
                var excludeDates=[""];
                function getDates(startDate, stopDate, excludeDates) {
                    var dateArray = [];
                    var currentDate = moment(startDate);
                    var stopDate = moment(stopDate);
                    while (currentDate <= stopDate) {
                        let currentDateString=moment(currentDate).format('DD');
                        if(!excludeDates.includes(currentDateString)){
                            dateArray.push( moment(currentDate).format('DD') )
                        }
                        currentDate = moment(currentDate).add(1, 'days');
                    }
                    return dateArray;
                }
                tpr_date=getDates(new Date(tpr_start_date),new Date(tpr_end_date), excludeDates);

                $.ajax({
                    type: "Post",
                    url: "GetTPRData",
                    data: tpr_sch,
                    dataType: "json",
                    success: function (result) {
                        pulse = result.TPRPulse;
                        temp = result.TPRTemp;
                        breath = result.TPRBreath;
                        createChart();
                    }
                });

                $(document).bind("kendo:skinChange", createChart);
            })

        })
        function createChart() {
            $("#tpr_chart").kendoChart({
                legend: {
                    position: "top"
                },
                series: [{
                    type: "line",
                    data: temp,
                    name: "體溫 [&deg;C]",
                    color: "#ff1c1c",
                    axis: "temp"
                }, {
                    type: "line",
                    data: pulse,
                    name: "脈搏 [次]",
                    color: "#ffae00",
                    axis: "pulse"
                }, {
                    type: "line",
                    data: breath,
                    name: "呼吸 [次]",
                    color: "#73c100",
                    axis: "breath"
                }, ],
                valueAxes: [{
                    name: "breath",
                    color: "#73c100",
                    min: 10,
                    max: 80
                }, {
                    name: "pulse",
                    color: "#ffae00",
                    min: 40,
                    max: 180
                }, {
                    name: "temp",
                    color: "#ff1c1c",
                    min: 35,
                    max: 42
                }],
                categoryAxis: {
                    categories: tpr_date,
                    axisCrossingValues: [0, 0, 0],
                    justified: true
                },
                tooltip: {
                    visible: true,
                    format: "{0}",
                    template: "#= series.name #: #= value #"
                }
            });
        }

        var today = new Date("2020-06-17");
        var year = today.getFullYear();
        var month = (today.getMonth()+1);
        var day = today.getDate();

        tpr_sch_week = {
            "PatientId":@Html.Raw(Json.Encode(ViewBag.search_id)),
            "TPRStart":year + "-"+month+"-"+day,
        }

        var myDate = new Date("2020-06-17");
        myDate.setDate(myDate.getDate() - 13);
        var dateArray = [];
        var dateTemp;
        var flag = 1;
        for (var i = 0; i < 14; i++) {
            dateTemp = (myDate.getMonth() + 1) + "/" + myDate.getDate();
            dateArray.push(dateTemp);
            myDate.setDate(myDate.getDate() + flag);
        }
        $.ajax({
            type: "Post",
            url: "GetTPRDataWeek",
            data: tpr_sch_week,
            dataType: "json",
            success: function (result) {
                pulse_week = result.TPRPulse;
                temp_week = result.TPRTemp;
                breath_week = result.TPRBreath;
                createChartweeks();
            }
        });
        function createChartweeks(){

            $("#tpr_chart_week").kendoChart({
                legend: {
                    position: "top"
                },
                series: [{
                    type: "line",
                    data: temp_week,
                    name: "體溫 [&deg;C]",
                    color: "#ff1c1c",
                    axis: "temp"
                }, {
                    type: "line",
                    data: pulse_week,
                    name: "脈搏 [次]",
                    color: "#ffae00",
                    axis: "pulse"
                }, {
                    type: "line",
                    data: breath_week,
                    name: "呼吸 [次]",
                    color: "#73c100",
                    axis: "breath"
                }, ],
                valueAxes: [{
                    name: "breath",
                    color: "#73c100",
                    min: 10,
                    max: 80
                }, {
                    name: "pulse",
                    color: "#ffae00",
                    min: 40,
                    max: 180
                }, {
                    name: "temp",
                    color: "#ff1c1c",
                    min: 35,
                    max: 42
                }],
                categoryAxis: {
                    categories: dateArray,
                    axisCrossingValues: [0, 0, 0],
                    justified: true
                },
                tooltip: {
                    visible: true,
                    format: "{0}",
                    template: "#= series.name #: #= value #"
                }
            });
        }


        $("#note_history").click(function(e){
            $("#note_grid").kendoGrid({
                dataSource: {
                    transport: {
                        read: {
                            method: "post",
                            url: "GetPatientNote",
                            dataType: "json",
                            data: { "PatientId": patient_id_search }
                        }
                    },
                    pageSize: 20,
                },
                width:screen.height*0.5,
                height:screen.height*0.7,
                columns: [
                    { field: "UserName", title: "輸入人員", width: "20%" },
                    { field: "NoteDate", title: "日期", width: "20%" },
                    { field: "Note", title: "內容", width: "60%" },
                ]
            });
            $("#note_window").data("kendoWindow").center().open();
        })
        $("#note_insert").click(function(){
            var insert={
                "PatientId":patient_id_search,
                "UserName":"test",
                "NoteDate":getTodayDate(),
                "Note":$("#patinetNote").val()
            }
            console.log(insert)
            $.ajax({
                type: "post",
                url: "InsertNote",
                data: insert,
                success: function (response) {
                    if (response == true) {
                        alert("資料已新增");
                        var PatientId = patient_id_search
                        $.ajax({
                            type: "post",
                            url: "Getifo",
                            data: { "PatientId": PatientId },
                            success: function (response) {
                                if (response == true) {
                                    window.location.href = "Switch"
                                }
                            }
                        });
                    }
                },
                error: function (error) {
                    alert("系統發生錯誤");
                }
            });
        })
        function getTodayDate() {
            var fullDate = new Date();
            var yyyy = fullDate.getFullYear();
            var MM = (fullDate.getMonth() + 1) >= 10 ? (fullDate.getMonth() + 1) : ("0" + (fullDate.getMonth() + 1));
            var dd = fullDate.getDate() < 10 ? ("0"+fullDate.getDate()) : fullDate.getDate();
            var today = yyyy + "-" + MM + "-" + dd;
            return today;
        }

    })
</script>

<!--I/O圖 CSS-->
<style type="text/css">
    .andy_tag, .fullio_tag {
        display: block;
        width: 0px;
        height: 0px;
    }

    .tubeiogrid_box {
        background-color: rgba(76, 115, 178, 0.52 );
        height: 100px;
        width: 100%;
    }

    .fulliogrid_box {
        background-color: rgba(76, 115, 178, 0.52 );
        height: 100%;
        width: 100%;
    }

    #tabstrip_andyfullio h2 {
        font-weight: lighter;
        font-size: 5em;
        line-height: 1;
        padding: 0 0 0 30px;
        margin: 0;
    }

        #tabstrip_andyfullio h2 span {
            background: none;
            padding-left: 5px;
            font-size: .3em;
            vertical-align: top;
        }

    #tabstrip_andyfullio p {
        margin: 0;
        padding: 0;
    }

    .tube_tag, .tubeio_tag {
        display: block;
        width: 0px;
        height: 0px;
    }

    .tubeiogrid_box {
        background-color: rgba(76, 115, 178, 0.52 );
        height: 100px;
        width: 100%;
    }

    .fulliogrid_box {
        background-color: rgba(76, 115, 178, 0.52 );
        height: 100%;
        width: 100%;
    }


    #tabstrip_tubeio h2 {
        font-weight: lighter;
        font-size: 5em;
        line-height: 1;
        padding: 0 0 0 30px;
        margin: 0;
    }

        #tabstrip_tubeio h2 span {
            background: none;
            padding-left: 5px;
            font-size: .3em;
            vertical-align: top;
        }

    #tabstrip_tubeio p {
        margin: 0;
        padding: 0;
    }

    /* Three image containers (use 25% for four, and 50% for two, etc) */
    .fulliogrid_box {
        float: left;
        width: 49%;
    }

    /* Clear floats after image containers */
    .fulliorow::after {
        content: "";
        clear: both;
        display: table;
    }
</style>
